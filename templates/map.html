{% extends "base.html" %}

{% block title %}Explore Danish Hills | Gradient Explorer{% endblock %}

{% block content %}
<main class="w-full overflow-hidden relative py-6">
    <!-- Map View with Side Panel -->
    <div class="container mx-auto px-4">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Sidebar -->
            <div class="lg:w-1/4 space-y-6 z-10">
                <!-- Logo and Title -->
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <h1 class="text-3xl font-bold text-gray-800">Danish <span class="text-blue-500">Hills</span></h1>
                    <p class="text-gray-600 mt-2">Discover and conquer the best climbs</p>
                </div>
                
                <!-- Search -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Search for a climb..." 
                            class="w-full px-4 py-3 bg-gray-50 rounded-lg border-gray-200 focus:border-blue-500 focus:ring focus:ring-blue-200 text-gray-800"
                        >
                        <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                        Filters
                    </h2>
                    <form id="filter-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gradient Range</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <input 
                                        type="number" 
                                        name="min_gradient" 
                                        placeholder="Min %" 
                                        min="0"
                                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-500"
                                    >
                                </div>
                                <div>
                                    <input 
                                        type="number" 
                                        name="max_gradient" 
                                        placeholder="Max %" 
                                        min="0"
                                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-500"
                                    >
                                </div>
                            </div>
                            <!-- Gradient slider UI -->
                            <div id="gradient-slider" class="mt-2 px-1">
                                <div class="h-2 bg-gradient-to-r from-green-300 via-yellow-300 to-red-500 rounded-full"></div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Length (m)</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <input 
                                        type="number" 
                                        name="min_length" 
                                        placeholder="Min" 
                                        min="0" 
                                        step="100"
                                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-500"
                                    >
                                </div>
                                <div>
                                    <input 
                                        type="number" 
                                        name="max_length" 
                                        placeholder="Max" 
                                        min="0"
                                        step="100"
                                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-500"
                                    >
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select 
                                name="category" 
                                class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-500"
                            >
                                <option value="">All Categories</option>
                                <option value="HC">HC (Hors Categorie)</option>
                                <option value="1">Category 1</option>
                                <option value="2">Category 2</option>
                                <option value="3">Category 3</option>
                                <option value="4">Category 4</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                            <select 
                                name="region" 
                                class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring focus:ring-blue-200 focus:border-blue-500"
                            >
                                <option value="">All Regions</option>
                                <!-- Regions will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="pt-2">
                            <button 
                                type="submit" 
                                class="w-full bg-blue-500 text-white rounded-lg py-3 px-4 flex items-center justify-center hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                </svg>
                                Apply Filters
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Selected Hill Info (initially hidden) -->
                <div id="selected-hill-info" class="bg-white rounded-xl shadow-lg p-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Hill Details</h2>
                        <button id="close-details" class="text-gray-400 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div id="hill-details" class="space-y-4">
                        <!-- Hill details will be loaded here -->
                    </div>
                    <div id="elevation-profile" class="mt-4 h-40 bg-gray-100 rounded-lg">
                        <!-- Elevation profile will be rendered here -->
                    </div>
                    <div class="mt-4 text-center">
                        <a id="view-hill-details" href="#" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            View Full Details
                        </a>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Statistics</h2>
                    <div id="statsContainer" class="space-y-3">
                        <p>Loading statistics...</p>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="lg:w-3/4">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <!-- Map Controls -->
                    <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <button id="toggle-heatmap" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-colors flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd" />
                                </svg>
                                Gradient Heatmap
                            </button>
                            <button id="toggle-3d" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6.672 1.911a1 1 0 10-1.932.518l.259.966a1 1 0 001.932-.518l-.26-.966zM2.429 4.74a1 1 0 10-.517 1.932l.966.259a1 1 0 00.517-1.932l-.966-.26zm8.814-.569a1 1 0 00-1.415-1.414l-.707.707a1 1 0 101.415 1.415l.707-.708zm-7.071 7.072l.707-.707A1 1 0 003.465 9.12l-.708.707a1 1 0 001.415 1.415zm3.2-5.171a1 1 0 00-1.3 1.3l4 10a1 1 0 001.823.075l1.38-2.759 3.018 3.02a1 1 0 001.414-1.415l-3.019-3.02 2.76-1.379a1 1 0 00-.076-1.822l-10-4z" clip-rule="evenodd" />
                                </svg>
                                3D Terrain
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="zoom-in" class="p-1.5 bg-white rounded-lg shadow text-gray-700 hover:bg-gray-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button id="zoom-out" class="p-1.5 bg-white rounded-lg shadow text-gray-700 hover:bg-gray-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button id="locate-me" class="p-1.5 bg-white rounded-lg shadow text-gray-700 hover:bg-gray-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Map -->
                    <div id="map" class="h-[700px] w-full"></div>
                    
                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" class="absolute top-4 right-4 bg-white p-2 rounded-md shadow-md hidden">
                        <div class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Hills Section -->
        <div class="mt-10">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Top 10 Danish Hills</h2>
                
                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-3 mb-6">
                    <button 
                        class="px-4 py-2 rounded-lg bg-blue-500 text-white font-medium hover:bg-blue-600 transition-colors"
                        data-filter="longest">
                        Longest Climbs
                    </button>
                    <button 
                        class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors"
                        data-filter="steepest">
                        Steepest Climbs
                    </button>
                    <button 
                        class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors"
                        data-filter="elevation">
                        Highest Gain
                    </button>
                </div>
                
                <!-- Hills Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 text-left">
                            <tr>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">#</th>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider text-right">Length</th>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider text-right">Elevation</th>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider text-right">Gradient</th>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200" id="top-hills-table">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading top hills data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_head %}
<!-- Mapbox CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
<style>
    /* Custom CSS for the app */
    .mapboxgl-ctrl-logo, .mapboxgl-ctrl-attrib {
        display: none !important;
    }
    
    /* Transition effects */
    .fadeIn {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Custom marker styling */
    .hill-marker {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 0 rgba(66, 153, 225, 0.4);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(66, 153, 225, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(66, 153, 225, 0);
        }
    }
    
    /* Gradient cards */
    .gradient-card {
        transition: all 0.3s ease;
    }
    
    .gradient-card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<!-- Chart.js for elevation profiles -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Mapbox map
        mapboxgl.accessToken = '{{ mapbox_token }}';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v12', // Outdoor style good for terrain
            center: [10.4513, 55.7132], // Center on Denmark
            zoom: 7,
            pitch: 30, // Slight 3D effect
        });
        
        // Add map controls
        map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
        
        // Variables to hold map data
        let hillsData = null;
        let selectedHill = null;
        let elevationChart = null;
        
        // Add terrain and sky layer when map loads
        map.on('load', function() {
            // Add 3D terrain if available
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            
            // Add terrain layer (initially enabled)
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
            
            // Add sky layer
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });
            
            // Initialize map layers
            initMapLayers();
            
            // Load initial hills data
            loadHills();
            
            // Load statistics
            loadStatistics();
            
            // Load top hills
            loadTopHills('longest');
        });
        
        // Initialize map layers
        function initMapLayers() {
            // Add source for hills
            map.addSource('hills', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });
            
            // Add line layer for hills
            map.addLayer({
                id: 'hills-line',
                type: 'line',
                source: 'hills',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': [
                        'match',
                        ['get', 'category'],
                        'HC', '#FF0000', // Hors Categorie - Red
                        '1', '#FF6600',  // Category 1 - Orange
                        '2', '#FFCC00',  // Category 2 - Yellow
                        '3', '#00CC00',  // Category 3 - Green
                        '4', '#0066FF',  // Category 4 - Blue
                        '#808080'         // Default - Gray
                    ],
                    'line-width': 3
                }
            });
            
            // Add highlight layer for selected hill
            map.addLayer({
                id: 'selected-hill',
                type: 'line',
                source: 'hills',
                filter: ['==', ['get', 'id'], -1], // Start with no selection
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#FFFFFF',
                    'line-width': 6,
                    'line-opacity': 0.8
                }
            });
            
            // Add heatmap layer
            map.addLayer({
                id: 'gradient-heatmap',
                type: 'heatmap',
                source: 'hills',
                maxzoom: 15,
                paint: {
                    'heatmap-weight': [
                        'interpolate', ['linear'], ['get', 'avg_gradient'],
                        0, 0,
                        5, 0.5,
                        10, 1
                    ],
                    'heatmap-intensity': [
                        'interpolate', ['linear'], ['zoom'],
                        8, 0.5,
                        12, 1
                    ],
                    'heatmap-color': [
                        'interpolate', ['linear'], ['heatmap-density'],
                        0, 'rgba(0, 0, 255, 0)',
                        0.2, 'rgb(0, 255, 255)',
                        0.4, 'rgb(0, 255, 0)',
                        0.6, 'rgb(255, 255, 0)',
                        0.8, 'rgb(255, 0, 0)'
                    ],
                    'heatmap-radius': [
                        'interpolate', ['linear'], ['zoom'],
                        8, 8,
                        12, 15
                    ],
                    'heatmap-opacity': 0.6
                }
            });
            
            // Setup click handling for hills
            map.on('click', 'hills-line', function(e) {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    selectHill(feature);
                }
            });
            
            // Change cursor on hover
            map.on('mouseenter', 'hills-line', function() {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', 'hills-line', function() {
                map.getCanvas().style.cursor = '';
            });
        }
        
        // Load hills data with current filters
        function loadHills() {
            // Show loading indicator
            document.getElementById('loadingIndicator').classList.remove('hidden');
            
            // Get current map bounds for spatial filtering
            const bounds = map.getBounds();
            const bbox = [
                bounds.getWest(),
                bounds.getSouth(),
                bounds.getEast(),
                bounds.getNorth()
            ].join(',');
            
            // Get filter values
            const form = document.getElementById('filter-form');
            const formData = new FormData(form);
            
            // Build query string
            let queryParams = new URLSearchParams();
            
            // Add form filters
            for (const [key, value] of formData.entries()) {
                if (value) {
                    queryParams.append(key, value);
                }
            }
            
            // Add bbox filter
            queryParams.append('bbox', bbox);
            
            // Fetch hills data
            fetch(`/api/hills?${queryParams.toString()}`)
                .then(response => response.json())
                .then(data => {
                    // Store the data
                    hillsData = data;
                    
                    // Update the source
                    map.getSource('hills').setData(data);
                    
                    // Clear selection
                    if (selectedHill) {
                        map.setFilter('selected-hill', ['==', ['get', 'id'], -1]);
                        selectedHill = null;
                    }
                    
                    // Hide loading indicator
                    document.getElementById('loadingIndicator').classList.add('hidden');
                })
                .catch(error => {
                    console.error('Error loading hills:', error);
                    document.getElementById('loadingIndicator').classList.add('hidden');
                });
        }
        
        // Select a hill
        function selectHill(feature) {
            selectedHill = feature;
            const properties = feature.properties;
            
            // Update the selection filter
            map.setFilter('selected-hill', ['==', ['get', 'id'], properties.id]);
            
            // Load hill details
            fetch(`/api/hills/${properties.id}`)
                .then(response => response.json())
                .then(hill => {
                    // Update hill details panel
                    document.getElementById('hill-details').innerHTML = `
                        <div class="space-y-3">
                            <h3 class="text-xl font-bold text-gray-900">${hill.name || 'Hill ' + hill.id}</h3>
                            <div class="flex items-center">
                                <span class="text-sm py-1 px-2 rounded-full ${hill.avg_gradient > 8 ? 'bg-red-100 text-red-800' : hill.avg_gradient > 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                    Category ${hill.category} - ${hill.avg_gradient.toFixed(1)}% Avg
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-600">Length</p>
                                    <p class="font-medium">${hill.length_m.toFixed(0)} m</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Elevation Gain</p>
                                    <p class="font-medium">${hill.elevation_gain.toFixed(1)} m</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Start Elevation</p>
                                    <p class="font-medium">${hill.start_elevation.toFixed(1)} m</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Max Gradient</p>
                                    <p class="font-medium">${hill.max_gradient.toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update view details link
                    document.getElementById('view-hill-details').href = `/hill/${hill.id}`;
                    
                    // Create elevation profile chart
                    createElevationChart(hill.elevation_profile);
                    
                    // Show hill details panel
                    document.getElementById('selected-hill-info').classList.remove('hidden');
                    
                    // Fit map to the hill geometry
                    const bounds = new mapboxgl.LngLatBounds();
                    
                    // Add all coordinates of the linestring to the bounds
                    if (hill.geometry.type === 'LineString') {
                        hill.geometry.coordinates.forEach(coord => {
                            bounds.extend(coord);
                        });
                    }
                    
                    // Fit map to bounds
                    map.fitBounds(bounds, {
                        padding: { top: 50, bottom: 50, left: 300, right: 50 },
                        duration: 1000
                    });
                })
                .catch(error => {
                    console.error('Error loading hill details:', error);
                });
        }
        
        // Create elevation profile chart
        function createElevationChart(elevationProfile) {
            if (!elevationProfile || elevationProfile.length < 2) {
                document.getElementById('elevation-profile').innerHTML = 
                    '<div class="flex h-full items-center justify-center text-gray-500">No elevation data available</div>';
                return;
            }
            
            // Prepare data for Chart.js
            const distances = elevationProfile.map(point => point[0]);
            const elevations = elevationProfile.map(point => point[1]);
            
            // Create gradient for chart
            const ctx = document.getElementById('elevation-profile').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.1)');
            
            // Destroy previous chart if it exists
            if (elevationChart) {
                elevationChart.destroy();
            }
            
            // Create new chart
            elevationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: distances,
                    datasets: [{
                        label: 'Elevation (m)',
                        data: elevations,
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Distance (m)'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Elevation (m)'
                            }
                        }
                    }
                }
            });
        }
        
        // Load statistics
        function loadStatistics() {
            fetch('/api/hills/stats')
                .then(response => response.json())
                .then(response => {
                    const data = response.data;
                    const statsContainer = document.getElementById('statsContainer');
                    
                    // Create statistics HTML
                    let html = `
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Hills:</span>
                                <span class="font-semibold text-gray-900">${data.total_hills}</span>
                            </div>
                    `;
                    
                    // Add gradient stats
                    if (data.gradient) {
                        html += `
                            <div class="flex justify-between">
                                <span class="text-gray-600">Average Gradient:</span>
                                <span class="font-semibold text-gray-900">${data.gradient.average.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Max Gradient:</span>
                                <span class="font-semibold text-gray-900">${data.gradient.max.toFixed(1)}%</span>
                            </div>
                        `;
                    }
                    
                    // Add length stats
                    if (data.length) {
                        html += `
                            <div class="flex justify-between">
                                <span class="text-gray-600">Average Length:</span>
                                <span class="font-semibold text-gray-900">${data.length.average.toFixed(0)} m</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Longest Hill:</span>
                                <span class="font-semibold text-gray-900">${data.length.max.toFixed(0)} m</span>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    
                    // Update the container
                    statsContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    document.getElementById('statsContainer').innerHTML = '<p>Failed to load statistics</p>';
                });
        }
        
        // Load top hills
        function loadTopHills(filter) {
            fetch(`/api/hills?${filter === 'longest' ? 'min_length=100&sort=length' : filter === 'steepest' ? 'min_gradient=3&sort=gradient' : 'sort=elevation'}&limit=10`)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        const tableBody = document.getElementById('top-hills-table');
                        tableBody.innerHTML = '';
                        
                        data.features.forEach((feature, index) => {
                            const properties = feature.properties;
                            const tr = document.createElement('tr');
                            tr.className = 'hover:bg-gray-50 transition-colors';
                            
                            tr.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${properties.name || 'Hill ' + properties.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">${properties.length_m.toFixed(0)} m</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">${properties.elevation_gain.toFixed(1)} m</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${properties.avg_gradient > 8 ? 'bg-red-100 text-red-800' : properties.avg_gradient > 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                        ${properties.avg_gradient.toFixed(1)}%
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                    <button 
                                        onclick="showOnMap(${properties.id})" 
                                        class="text-blue-600 hover:text-blue-900 font-medium"
                                    >
                                        Show on Map
                                    </button>
                                </td>
                            `;
                            
                            tableBody.appendChild(tr);
                        });
                    } else {
                        document.getElementById('top-hills-table').innerHTML = `
                            <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hills found</td></tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading top hills:', error);
                    document.getElementById('top-hills-table').innerHTML = `
                        <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Error loading top hills</td></tr>
                    `;
                });
        }
        
        // Custom map controls
        document.getElementById('zoom-in').addEventListener('click', function() {
            map.zoomIn();
        });
        
        document.getElementById('zoom-out').addEventListener('click', function() {
            map.zoomOut();
        });
        
        document.getElementById('locate-me').addEventListener('click', function() {
            // Get user location and center map
            navigator.geolocation.getCurrentPosition(function(position) {
                map.flyTo({
                    center: [position.coords.longitude, position.coords.latitude],
                    zoom: 14,
                    essential: true
                });
                
                // Add marker at user location
                new mapboxgl.Marker({ color: '#3b82f6' })
                    .setLngLat([position.coords.longitude, position.coords.latitude])
                    .addTo(map);
            }, function(error) {
                console.error('Error getting location:', error);
                alert('Unable to get your location. Please check your location permissions.');
            });
        });
        
        // Toggle 3D terrain
        let terrainEnabled = true;
        document.getElementById('toggle-3d').addEventListener('click', function() {
            terrainEnabled = !terrainEnabled;
            
            if (terrainEnabled) {
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                this.classList.replace('bg-gray-100', 'bg-blue-100');
                this.classList.replace('text-gray-700', 'text-blue-700');
            } else {
                map.setTerrain(null);
                this.classList.replace('bg-blue-100', 'bg-gray-100');
                this.classList.replace('text-blue-700', 'text-gray-700');
            }
        });
        
        // Toggle heatmap layer
        let heatmapEnabled = true;
        document.getElementById('toggle-heatmap').addEventListener('click', function() {
            heatmapEnabled = !heatmapEnabled;
            
            if (heatmapEnabled) {
                map.setLayoutProperty('gradient-heatmap', 'visibility', 'visible');
                this.classList.replace('bg-gray-100', 'bg-blue-100');
                this.classList.replace('text-gray-700', 'text-blue-700');
            } else {
                map.setLayoutProperty('gradient-heatmap', 'visibility', 'none');
                this.classList.replace('bg-blue-100', 'bg-gray-100');
                this.classList.replace('text-blue-700', 'text-gray-700');
            }
        });
        
        // Filter form handling
        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            loadHills();
        });
        
        // Close hill details panel
        document.getElementById('close-details').addEventListener('click', function() {
            document.getElementById('selected-hill-info').classList.add('hidden');
            
            // Clear hill selection
            map.setFilter('selected-hill', ['==', ['get', 'id'], -1]);
            selectedHill = null;
        });
        
        // Handle top hills filtering
        document.querySelectorAll('[data-filter]').forEach(button => {
            button.addEventListener('click', function() {
                // Update active button style
                document.querySelectorAll('[data-filter]').forEach(btn => {
                    btn.classList.replace('bg-blue-500', 'bg-gray-200');
                    btn.classList.replace('text-white', 'text-gray-700');
                });
                this.classList.replace('bg-gray-200', 'bg-blue-500');
                this.classList.replace('text-gray-700', 'text-white');
                
                // Filter type
                const filterType = this.getAttribute('data-filter');
                
                // Load filtered hills
                loadTopHills(filterType);
            });
        });
        
        // Reload hills when map moves
        map.on('moveend', function() {
            loadHills();
        });
        
        // Function to show hill on map (called from outside)
        window.showOnMap = function(hillId) {
            // Fetch hill data
            fetch(`/api/hills/${hillId}`)
                .then(response => response.json())
                .then(hill => {
                    // Create a feature for the hill
                    const feature = {
                        type: 'Feature',
                        properties: hill,
                        geometry: hill.geometry
                    };
                    
                    // Select the hill
                    selectHill({ properties: hill, geometry: hill.geometry });
                    
                    // Update the selection filter
                    map.setFilter('selected-hill', ['==', ['get', 'id'], hill.id]);
                    
                    // Fly to hill location
                    const coordinates = hill.geometry.coordinates;
                    const bounds = coordinates.reduce(function(bounds, coord) {
                        return bounds.extend(coord);
                    }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                    
                    map.fitBounds(bounds, {
                        padding: { top: 50, bottom: 50, left: 300, right: 50 },
                        duration: 1000
                    });
                })
                .catch(error => {
                    console.error('Error fetching hill details:', error);
                });
        };
    });
</script>
{% endblock %}